name: Ubuntu RDP Minimal
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Minimal RDP
      run: |
        sudo apt update -y
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xrdp xfce4 xfce4-goodies xorg dbus-x11 wget curl || true
        sudo useradd -m -s /bin/bash ubuntuuser || true
        echo 'ubuntuuser:P@ssw0rd!' | sudo chpasswd || true
        sudo usermod -aG sudo ubuntuuser || true
        echo "startxfce4" | sudo tee /home/ubuntuuser/.xsession || true
        sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser || true
        sudo chmod 755 /home/ubuntuuser/.xsession || true
        sudo systemctl start xrdp || true
        sudo systemctl enable xrdp || true
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz || true
        tar xvzf ngrok-v3-stable-linux-amd64.tgz || true
        sudo mv ngrok /usr/local/bin/ || true
        rm ngrok-v3-stable-linux-amd64.tgz || true
        ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }} || true
        sudo nohup ngrok tcp 3389 --log=/tmp/ngrok.log > /dev/null 2>&1 &
        sleep 20
        NGROK_URL=$(curl -s https://api.ngrok.com/tunnels 2>/dev/null | grep -o '"public_url":"tcp://[^"]*"' | head -1 | cut -d'"' -f4 || echo "Check dashboard.ngrok.com")
        echo "=========================================="
        echo "XFCE RDP: ubuntuuser / P@ssw0rd!"
        echo "Ngrok: $NGROK_URL"
        echo "Or visit https://dashboard.ngrok.com/status/tunnels"
        echo "=========================================="
        tail -f /tmp/ngrok.log
      shell: bash
    - name: Keep Alive
      if: always()
      run: sleep 6h
