name: Ubuntu RDP
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup RDP & Ngrok Tunnel
      run: |
        sudo apt update -y
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xrdp ubuntu-desktop-minimal xfce4 xfce4-goodies wget curl
        sudo useradd -m -s /bin/bash ubuntuuser || true
        echo 'ubuntuuser:P@ssw0rd!' | sudo chpasswd
        sudo usermod -aG sudo ubuntuuser
        echo "xfce4-session" | sudo tee /home/ubuntuuser/.xsession
        sudo chown -R ubuntuuser:ubuntuuser /home/ubuntuuser
        sudo chmod 755 /home/ubuntuuser/.xsession
        sudo systemctl start xrdp
        sudo systemctl enable xrdp
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        sudo mv ngrok /usr/local/bin/
        rm ngrok-v3-stable-linux-amd64.tgz
        ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        sudo nohup ngrok tcp 3389 --log=/tmp/ngrok.log > /dev/null 2>&1 &
        sleep 15
        NGROK_URL=$(curl -s https://api.ngrok.com/tunnels | grep -o '"public_url":"tcp://[^"]*"' | cut -d'"' -f4)
        echo "=========================================="
        echo "RDP Username: ubuntuuser"
        echo "Password: P@ssw0rd!"
        echo "Ngrok RDP URL: $NGROK_URL"
        echo "Connect: Host=$(echo $NGROK_URL | cut -d: -f2 | cut -d/ -f3) Port=$(echo
