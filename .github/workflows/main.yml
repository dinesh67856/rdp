name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest

    steps:
    # 1️⃣ Install SSH (already present on macOS, but just in case)
    - name: Enable SSH
      run: |
        sudo systemsetup -setremotelogin on

    # 2️⃣ Add your public key to runner
    - name: Add SSH public key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PUBLIC_KEY }}" >> ~/.ssh/authorized_keys
        chmod 700 ~/.ssh
        chmod 600 ~/.ssh/authorized_keys

    # 3️⃣ Install tools (ngrok + jq)
    - name: Install ngrok and jq
      run: |
        brew install ngrok jq
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    # 4️⃣ Start ngrok SSH tunnel
    - name: Start ngrok SSH Tunnel
      run: |
        nohup ngrok tcp 22 > ngrok-ssh.log 2>&1 &

    # 5️⃣ Show SSH info
    - name: Show SSH Connection Info
      run: |
        sleep 6
        echo "========== SSH =========="
        curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url'
        echo "Use this command to connect:"
        echo "ssh -i <path_to_private_key> runner@<host_from_above> -p <port_from_above>"
        echo "========================="
        sleep 18000
