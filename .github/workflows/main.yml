name: Ubuntu RDP with Ngrok

on: [push, workflow_dispatch]

jobs:
  setup-rdp:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install xrdp and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xrdp xorgxrdp jq
    
    - name: Configure xrdp
      run: |
        echo "exec /usr/bin/xfce4-session" > ~/.xsession
        sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
        sudo systemctl restart xrdp
        sudo systemctl enable xrdp
    
    - name: Create new user for RDP
      run: |
        # Create a new user for RDP access
        sudo useradd -m -s /bin/bash rduser
        echo "rduser:P@ssw0rd123" | sudo chpasswd
        sudo usermod -aG sudo rduser
    
    - name: Download ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # Set ngrok auth token
        ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
    
    - name: Start ngrok tunnel and display info
      run: |
        # Start ngrok tunnel for RDP
        ./ngrok tcp 3389 --log stdout &
        sleep 5
        
        # Display connection info
        echo "=== RDP Connection Details ==="
        
        # Try to get ngrok URL
        for i in {1..10}; do
          URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url' 2>/dev/null || echo "")
          if [ ! -z "$URL" ]; then
            echo "Success! Tunnel established."
            echo "Connect to: ${URL#tcp://}"
            echo "Username: rduser"
            echo "Password: P@ssw0rd123"
            break
          fi
          echo "Waiting for tunnel... ($i/10)"
          sleep 2
        done
        
        if [ -z "$URL" ]; then
          echo "Failed to establish tunnel. Check ngrok logs."
        fi
        
        echo "=== Tunnel will be active for 10 minutes ==="
        
        # Keep the workflow running
        sleep 600
