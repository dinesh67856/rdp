name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Install ngrok
      run: |
        ARCH=$(uname -m)
        if [ "$ARCH" = "x86_64" ]; then
          NGROK_URL="https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-amd64.zip"
        elif [ "$ARCH" = "arm64" ]; then
          NGROK_URL="https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-darwin-arm64.zip"
        else
          echo "Unsupported architecture: $ARCH"
          exit 1
        fi
        curl -L $NGROK_URL -o ngrok.zip
        unzip ngrok.zip
        sudo mv ngrok /usr/local/bin/ngrok
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Start ngrok TCP tunnel (port 22)
      run: |
        nohup ngrok tcp 22 --region=in > ngrok-ssh.log 2>&1 &

    - name: Show ngrok tunnel
      run: |
        sleep 6
        echo "========== TCP Tunnel =========="
        curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[] | select(.proto=="tcp") | .public_url'
        echo "==============================="
        sleep 3600
