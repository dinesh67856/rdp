name: Ubuntu Desktop Virtual Machine

on:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  build:
    name: Linux System Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setting Up the Ubuntu Environment
        run: |
          set -e

          # Hardcoded credentials (TEMPORARY)
          USERNAME="githubuser"
          PASSWORD="Password123!"
          RDP_PORT="3390"

          export NGROK_AUTH_TOKEN="${{ secrets.NGROK_AUTH_TOKEN }}"

          cat > linux-desktop-hardcoded.sh << 'EOF'
          #!/bin/bash
          set -e

          USERNAME="githubuser"
          PASSWORD="Password123!"
          RDP_PORT="3390"

          echo "Updating system..."
          sudo apt-get update

          echo "Installing desktop & RDP..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xrdp dbus-x11 x11-xserver-utils

          echo "Creating user..."
          if ! id "$USERNAME" &>/dev/null; then
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:$PASSWORD" | sudo chpasswd
            sudo usermod -aG sudo "$USERNAME"
          fi

          echo "Configuring XFCE session..."
          sudo -u "$USERNAME" bash <<EOL
          echo "startxfce4" > /home/$USERNAME/.xsession
          chmod +x /home/$USERNAME/.xsession
          EOL

          echo "Configuring XRDP..."
          sudo sed -i "s/port=3389/port=$RDP_PORT/g" /etc/xrdp/xrdp.ini
          sudo sed -i 's/^test -x/#test -x/' /etc/xrdp/startwm.sh
          sudo sed -i 's/^exec /#exec /' /etc/xrdp/startwm.sh

          cat << 'EOL' | sudo tee -a /etc/xrdp/startwm.sh
          unset DBUS_SESSION_BUS_ADDRESS
          unset XDG_RUNTIME_DIR
          exec startxfce4 &
          EOL

          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

          echo "XRDP status:"
          sudo systemctl status xrdp --no-pager || true

          echo "Installing ngrok..."
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz

          if [ -n "$NGROK_AUTH_TOKEN" ]; then
            ./ngrok config add-authtoken "$NGROK_AUTH_TOKEN"
            ./ngrok tcp $RDP_PORT &
          else
            echo "NGROK_AUTH_TOKEN not set!"
          fi

          echo "=================================="
          echo "RDP READY"
          echo "Username: $USERNAME"
          echo "Password: $PASSWORD"
          echo "Port: $RDP_PORT"
          echo "=================================="
          EOF

          chmod +x linux-desktop-hardcoded.sh
          bash linux-desktop-hardcoded.sh

      - name: Keep Running Ubuntu System and keepAlive
        run: sleep 6h
