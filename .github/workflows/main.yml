name: Ubuntu RDP with Ngrok

on: [push, workflow_dispatch]

jobs:
  setup-rdp:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install xrdp and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xrdp xorgxrdp jq
    
    - name: Configure xrdp
      run: |
        echo "exec /usr/bin/xfce4-session" > ~/.xsession
        sudo sed -i 's/use_vsock=true/use_vsock=false/g' /etc/xrdp/xrdp.ini
        sudo systemctl restart xrdp
        sudo systemctl enable xrdp
    
    - name: Set password for ubuntu user
      run: |
        echo "ubuntu:P@ssw0rd123" | sudo chpasswd
    
    - name: Download ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        
        # Set ngrok auth token
        ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
    
    - name: Start ngrok tunnel
      run: |
        # Start ngrok
        ./ngrok tcp 3389 --log stdout &
        sleep 5
        
        # Display connection info
        echo "=== RDP Connection Details ==="
        echo "Waiting for tunnel..."
        
        # Try to get ngrok URL
        for i in {1..10}; do
          URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -o "tcp://[^\"]*" | head -1)
          if [ ! -z "$URL" ]; then
            echo "Success! Tunnel established."
            echo "Connect to: ${URL#tcp://}"
            echo "Username: ubuntu"
            echo "Password: P@ssw0rd123"
            break
          fi
          sleep 2
        done
        
        if [ -z "$URL" ]; then
          echo "Failed to establish tunnel. Check ngrok logs."
          echo "You might need to check: http://localhost:4040"
        fi
        
        echo "=== Tunnel will be active for 10 minutes ==="
        sleep 600
